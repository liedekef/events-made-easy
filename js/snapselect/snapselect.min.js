(function(){function SnapSelect(element,options={}){const select=element;const isMultiple=select.multiple;const dataOptions={liveSearch:select.hasAttribute("data-live-search")?select.getAttribute("data-live-search")==="true":undefined,maxSelections:select.hasAttribute("data-max-selections")?parseInt(select.getAttribute("data-max-selections")):select.hasAttribute("data-max-items")?parseInt(select.getAttribute("data-max-items")):undefined,placeholder:select.hasAttribute("data-placeholder")?select.getAttribute("data-placeholder"):undefined,clearAllButton:select.hasAttribute("data-clear-all-button")?select.getAttribute("data-clear-all-button")==="true":undefined,selectOptgroups:select.hasAttribute("data-select-optgroups")?select.getAttribute("data-select-optgroups")==="true":undefined,selectAllOption:select.hasAttribute("data-select-all-option")?select.getAttribute("data-select-all-option")==="true":undefined,closeOnSelect:select.hasAttribute("data-close-on-select")?select.getAttribute("data-close-on-select")==="true":undefined,allowEmpty:select.hasAttribute("data-allow-empty")?select.getAttribute("data-allow-empty")==="true":undefined};const config={liveSearch:dataOptions.liveSearch!==undefined?dataOptions.liveSearch:options.liveSearch!==undefined?options.liveSearch:false,maxSelections:dataOptions.maxSelections!==undefined?dataOptions.maxSelections:options.maxSelections!==undefined?options.maxSelections:options.maxItems!==undefined?options.maxItems:Infinity,placeholder:dataOptions.placeholder!==undefined?dataOptions.placeholder:options.placeholder!==undefined?options.placeholder:"Select...",clearAllButton:dataOptions.clearAllButton!==undefined?dataOptions.clearAllButton:options.clearAllButton!==undefined?options.clearAllButton:false,selectOptgroups:dataOptions.selectOptgroups!==undefined?dataOptions.selectOptgroups:options.selectOptgroups!==undefined?options.selectOptgroups:false,selectAllOption:dataOptions.selectAllOption!==undefined?dataOptions.selectAllOption:options.selectAllOption!==undefined?options.selectAllOption:false,closeOnSelect:dataOptions.closeOnSelect!==undefined?dataOptions.closeOnSelect:options.closeOnSelect!==undefined?options.closeOnSelect:true,allowEmpty:dataOptions.allowEmpty!==undefined?dataOptions.allowEmpty:options.allowEmpty!==undefined?options.allowEmpty:false,ajax:options.ajax||null,pageSize:options.pageSize!==undefined?options.pageSize:20,loadingText:options.loadingText!==undefined?options.loadingText:"Loading...",noResultsText:options.noResultsText!==undefined?options.noResultsText:"No results found",errorText:options.errorText!==undefined?options.errorText:"Error loading results"};if(config.ajax){config.ajax=Object.assign({method:"GET",delay:300,minimumInputLength:0,cache:true,headers:{},data:null,processResults:null},config.ajax)}const ajaxCache=new Map;let currentPage=1;let currentSearch="";let hasMorePages=false;let isLoadingAjax=false;let debounceTimer=null;let activeRequest=null;this.selectElement=select;this.config=config;this.isMultiple=isMultiple;const customSelect=document.createElement("div");customSelect.classList.add("snap-select");customSelect.setAttribute("role","combobox");customSelect.setAttribute("aria-expanded","false");customSelect.setAttribute("aria-haspopup","listbox");customSelect.style.width=select.width;customSelect.style.minWidth=select.minWidth;select.parentNode.insertBefore(customSelect,select);customSelect.appendChild(select);const selectedContainer=document.createElement("div");selectedContainer.classList.add("snap-select-selected");selectedContainer.setAttribute("aria-live","polite");selectedContainer.setAttribute("tabindex","0");customSelect.appendChild(selectedContainer);const tagContainer=document.createElement("div");tagContainer.classList.add("snap-select-tags");selectedContainer.appendChild(tagContainer);let itemsContainer=null;let dropdownOverlay=null;let searchInput=null;let clearSearchButton=null;let loadingIndicator=null;let infiniteAnchor=null;let infiniteObserver=null;const selectedValues=new Set;const checkboxMap=new Map;const updateDisplay=()=>{tagContainer.innerHTML="";Array.from(select.options).forEach(opt=>{opt.selected=selectedValues.has(opt.value)});select.dispatchEvent(new Event("change",{bubbles:true}));if(selectedValues.size===0){const placeholder=document.createElement("div");placeholder.classList.add("snap-select-placeholder");placeholder.textContent=config.placeholder;tagContainer.appendChild(placeholder)}else{Array.from(selectedValues).forEach(val=>{const option=select.querySelector(`option[value="${val}"]`);if(!option)return;const tag=document.createElement("div");tag.classList.add("snap-select-tag");tag.textContent=option.textContent;const removeButton=document.createElement("span");removeButton.classList.add("snap-select-remove");removeButton.textContent="×";removeButton.addEventListener("click",e=>{e.stopPropagation();selectedValues.delete(val);const checkbox=checkboxMap.get(val.toString());if(checkbox)checkbox.checked=false;updateDisplay()});tag.appendChild(removeButton);tagContainer.appendChild(tag)});if(config.clearAllButton){const clearAllButton=document.createElement("span");clearAllButton.classList.add("snap-select-clear-all");clearAllButton.textContent="×";clearAllButton.addEventListener("click",e=>{e.stopPropagation();selectedValues.clear();checkboxMap.forEach(cb=>cb.checked=false);updateDisplay()});tagContainer.appendChild(clearAllButton)}}};const closeDropdown=()=>{selectedContainer.focus();_cancelInfiniteObserver();if(activeRequest){activeRequest.abort();activeRequest=null}if(debounceTimer){clearTimeout(debounceTimer);debounceTimer=null}if(itemsContainer){itemsContainer.remove();itemsContainer=null}if(dropdownOverlay){dropdownOverlay.remove();dropdownOverlay=null}if(customSelect._cleanupHandlers){customSelect._cleanupHandlers();customSelect._cleanupHandlers=null}customSelect.setAttribute("aria-expanded","false")};const positionDropdown=()=>{if(!itemsContainer)return;const rect=selectedContainer.getBoundingClientRect();const scrollTop=window.pageYOffset||document.documentElement.scrollTop;const scrollLeft=window.pageXOffset||document.documentElement.scrollLeft;let left=rect.left+scrollLeft;let top=rect.bottom+scrollTop;itemsContainer.style.position="absolute";itemsContainer.style.left=`${left}px`;itemsContainer.style.top=`${top}px`;itemsContainer.style.width=`fit-content`;itemsContainer.style.minWidth=`${rect.width}px`;itemsContainer.style.boxSizing="border-box";itemsContainer.style.zIndex="10000";const dropdownRect=itemsContainer.getBoundingClientRect();const viewportWidth=window.innerWidth;if(dropdownRect.right>viewportWidth){left=Math.max(10,viewportWidth-dropdownRect.width-10);itemsContainer.style.left=`${left}px`}};function updateSingleSelect(text,noAllowEmpty=false){tagContainer.innerHTML="";const selectedText=document.createElement("div");selectedText.classList.add("snap-select-single-selected-text");selectedText.textContent=text;if(config.allowEmpty&&!noAllowEmpty){const removeButton=document.createElement("span");removeButton.classList.add("snap-select-clear-all");removeButton.textContent="×";removeButton.style.float="right";removeButton.addEventListener("click",e=>{e.stopPropagation();select.value="";updateSingleSelect(config.placeholder,true);select.dispatchEvent(new Event("change",{bubbles:true}))});selectedText.appendChild(removeButton);selectedText.style.display="inline-block";selectedText.style.width="100%"}tagContainer.appendChild(selectedText)}function updateVisibility(){if(!itemsContainer)return;const searchTerm=searchInput?searchInput.value.toLowerCase():"";Array.from(itemsContainer.querySelectorAll(".snap-select-optgroup")).forEach(group=>{let hasVisibleOption=false;Array.from(group.querySelectorAll(".snap-select-item")).forEach(item=>{const keywords=item.dataset.key?item.dataset.key.toLowerCase():"";const label=item.querySelector(".snap-select-label");const text=label?label.textContent.toLowerCase():"";if(text.includes(searchTerm)||keywords.includes(searchTerm)){item.style.display="";hasVisibleOption=true}else{item.style.display="none"}});const groupLabel=group.querySelector(".snap-select-optgroup-label");if(groupLabel&&(groupLabel.textContent.toLowerCase().includes(searchTerm)||hasVisibleOption)){group.style.display=""}else{group.style.display="none"}});Array.from(itemsContainer.querySelectorAll(".snap-select-item")).forEach(item=>{if(item.closest(".snap-select-optgroup"))return;const keywords=item.dataset.key?item.dataset.key.toLowerCase():"";const label=item.querySelector(".snap-select-label");const text=label?label.textContent.toLowerCase():"";if(text.includes(searchTerm)||keywords.includes(searchTerm)){item.style.display=""}else{item.style.display="none"}})}function _buildFetchParams(search,page){const ajaxCfg=config.ajax;const url=typeof ajaxCfg.url==="function"?ajaxCfg.url(search,page):ajaxCfg.url;let extraData={};if(typeof ajaxCfg.data==="function"){extraData=ajaxCfg.data(search,page)||{}}else if(ajaxCfg.data&&typeof ajaxCfg.data==="object"){extraData=ajaxCfg.data}const params=Object.assign({q:search,page:page,pageSize:config.pageSize},extraData);const method=(ajaxCfg.method||"GET").toUpperCase();const headers=Object.assign({"Content-Type":"application/json"},ajaxCfg.headers||{});let fetchUrl=url;let fetchInit={method:method,headers:headers};if(method==="GET"){const qs=new URLSearchParams(params).toString();fetchUrl=qs?`${url}${url.includes("?")?"&":"?"}${qs}`:url}else{fetchInit.body=JSON.stringify(params)}return{fetchUrl:fetchUrl,fetchInit:fetchInit}}function _cacheKey(search,page){return`${search}__p${page}`}function _showLoading(append){if(!itemsContainer)return;if(!append){Array.from(itemsContainer.querySelectorAll(".snap-select-item, .snap-select-optgroup, .snap-select-no-results, .snap-select-error, .snap-select-infinite-anchor")).forEach(el=>el.remove())}if(!loadingIndicator){loadingIndicator=document.createElement("div");loadingIndicator.classList.add("snap-select-loading");loadingIndicator.textContent=config.loadingText}itemsContainer.appendChild(loadingIndicator)}function _hideLoading(){if(loadingIndicator&&loadingIndicator.parentNode){loadingIndicator.remove()}}function _showMessage(text,cssClass){if(!itemsContainer)return;_hideLoading();const msg=document.createElement("div");msg.classList.add("snap-select-no-results",cssClass);msg.textContent=text;itemsContainer.appendChild(msg)}function _appendResults(results){if(!itemsContainer)return;_hideLoading();_cancelInfiniteObserver();results.forEach(item=>{if(!select.querySelector(`option[value="${item.id}"]`)){const opt=document.createElement("option");opt.value=item.id;opt.textContent=item.text;select.appendChild(opt)}const div=createOptionItem(select.querySelector(`option[value="${item.id}"]`));itemsContainer.appendChild(div)});if(hasMorePages){_attachInfiniteSentinel()}}function _attachInfiniteSentinel(){if(!itemsContainer)return;infiniteAnchor=document.createElement("div");infiniteAnchor.classList.add("snap-select-infinite-anchor");infiniteAnchor.style.height="1px";infiniteAnchor.style.width="100%";itemsContainer.appendChild(infiniteAnchor);infiniteObserver=new IntersectionObserver(entries=>{if(entries[0].isIntersecting&&hasMorePages&&!isLoadingAjax){_fetchPage(currentSearch,currentPage+1,true)}},{root:itemsContainer,threshold:.1});infiniteObserver.observe(infiniteAnchor)}function _cancelInfiniteObserver(){if(infiniteObserver){infiniteObserver.disconnect();infiniteObserver=null}if(infiniteAnchor&&infiniteAnchor.parentNode){infiniteAnchor.remove();infiniteAnchor=null}}function _fetchPage(search,page,append){if(isLoadingAjax)return;const ajaxCfg=config.ajax;const key=_cacheKey(search,page);if(ajaxCfg.cache&&ajaxCache.has(key)){const cached=ajaxCache.get(key);currentPage=page;hasMorePages=cached.hasMore;if(!append){Array.from(itemsContainer.querySelectorAll(".snap-select-item, .snap-select-optgroup, .snap-select-no-results, .snap-select-error, .snap-select-infinite-anchor")).forEach(el=>el.remove())}if(cached.results.length===0&&!append){_showMessage(config.noResultsText,"snap-select-no-results")}else{_appendResults(cached.results)}return}isLoadingAjax=true;_showLoading(append);if(activeRequest)activeRequest.abort();activeRequest=new AbortController;const{fetchUrl,fetchInit}=_buildFetchParams(search,page);fetchInit.signal=activeRequest.signal;fetch(fetchUrl,fetchInit).then(response=>{if(!response.ok)throw new Error(`HTTP ${response.status}`);return response.json()}).then(data=>{isLoadingAjax=false;activeRequest=null;let processed={results:[],hasMore:false};if(typeof ajaxCfg.processResults==="function"){processed=ajaxCfg.processResults(data,search,page)||processed}else{processed.results=Array.isArray(data.results)?data.results:Array.isArray(data)?data:[];processed.hasMore=!!data.hasMore}currentPage=page;hasMorePages=!!processed.hasMore;if(ajaxCfg.cache){ajaxCache.set(key,{results:processed.results,hasMore:hasMorePages})}if(!itemsContainer)return;if(!append){Array.from(itemsContainer.querySelectorAll(".snap-select-item, .snap-select-optgroup, .snap-select-no-results, .snap-select-error, .snap-select-infinite-anchor")).forEach(el=>el.remove())}if(processed.results.length===0&&!append){_showMessage(config.noResultsText,"snap-select-no-results")}else{_appendResults(processed.results)}}).catch(err=>{if(err.name==="AbortError")return;isLoadingAjax=false;activeRequest=null;console.error("[SnapSelect] AJAX error:",err);if(itemsContainer){_hideLoading();_showMessage(config.errorText,"snap-select-error")}})}function _triggerSearch(search){if(!config.ajax||!itemsContainer)return;const minLen=config.ajax.minimumInputLength||0;if(search.length<minLen){Array.from(itemsContainer.querySelectorAll(".snap-select-item, .snap-select-optgroup, .snap-select-no-results, .snap-select-error, .snap-select-infinite-anchor, .snap-select-loading")).forEach(el=>el.remove());return}currentSearch=search;currentPage=1;hasMorePages=false;_cancelInfiniteObserver();_fetchPage(search,1,false)}function populateItems(){if(!itemsContainer)return;itemsContainer.innerHTML="";checkboxMap.clear();if(config.ajax||config.liveSearch){const searchWrapper=document.createElement("div");searchWrapper.classList.add("snap-select-search-wrapper");itemsContainer.appendChild(searchWrapper);searchInput=document.createElement("input");searchInput.classList.add("snap-select-search");searchInput.setAttribute("placeholder",config.ajax?"Search...":"Search...");searchWrapper.appendChild(searchInput);clearSearchButton=document.createElement("span");clearSearchButton.classList.add("snap-select-clear-search");clearSearchButton.textContent="×";clearSearchButton.style.display="none";clearSearchButton.addEventListener("click",()=>{searchInput.value="";clearSearchButton.style.display="none";if(config.ajax){_triggerSearch("")}else{updateVisibility()}});searchWrapper.appendChild(clearSearchButton);searchInput.addEventListener("input",()=>{clearSearchButton.style.display=searchInput.value?"inline":"none";if(config.ajax){clearTimeout(debounceTimer);debounceTimer=setTimeout(()=>{_triggerSearch(searchInput.value.trim())},config.ajax.delay||300)}else{updateVisibility()}});searchInput.addEventListener("keydown",e=>{e.stopPropagation();if(e.key==="Escape")closeDropdown()})}if(config.ajax){_fetchPage("",1,false);return}if(isMultiple&&config.selectAllOption){const selectAllDiv=document.createElement("div");selectAllDiv.classList.add("snap-select-item","snap-select-all");const selectAllCheckbox=document.createElement("input");selectAllCheckbox.type="checkbox";selectAllCheckbox.classList.add("snap-select-checkbox");selectAllDiv.appendChild(selectAllCheckbox);const selectAllLabel=document.createElement("label");selectAllLabel.classList.add("snap-select-label");selectAllLabel.textContent="Select All";selectAllDiv.appendChild(selectAllLabel);selectAllDiv.addEventListener("click",e=>{e.stopPropagation();const allSelected=selectedValues.size===select.options.length;if(allSelected){selectedValues.clear();checkboxMap.forEach(cb=>cb.checked=false);selectAllCheckbox.checked=false}else{Array.from(select.options).forEach(option=>{if(selectedValues.size<config.maxSelections){selectedValues.add(option.value);const checkbox=checkboxMap.get(option.value);if(checkbox)checkbox.checked=true}});selectAllCheckbox.checked=true}updateDisplay()});itemsContainer.appendChild(selectAllDiv)}Array.from(select.children).forEach(child=>{if(child.tagName==="OPTGROUP"){const group=document.createElement("div");group.classList.add("snap-select-optgroup");const label=document.createElement("div");label.classList.add("snap-select-optgroup-label");label.textContent=child.label;label.style.fontWeight="bold";if(isMultiple&&config.selectOptgroups){label.addEventListener("click",e=>{e.stopPropagation();let addedCount=0;Array.from(child.children).forEach(option=>{if(selectedValues.size<config.maxSelections&&!selectedValues.has(option.value)){selectedValues.add(option.value);const checkbox=checkboxMap.get(option.value);if(checkbox)checkbox.checked=true;addedCount++}});if(addedCount>0)updateDisplay()})}group.appendChild(label);Array.from(child.children).forEach(option=>{group.appendChild(createOptionItem(option))});itemsContainer.appendChild(group)}else if(child.tagName==="OPTION"){const item=createOptionItem(child);item.dataset.optgroup="";itemsContainer.appendChild(item)}})}function createOptionItem(option){const optionDiv=document.createElement("div");optionDiv.classList.add("snap-select-item");optionDiv.dataset.value=option.value;optionDiv.dataset.key=option.dataset.key||"";if(isMultiple){const checkbox=document.createElement("input");checkbox.type="checkbox";checkbox.classList.add("snap-select-checkbox");checkbox.checked=selectedValues.has(option.value);optionDiv.appendChild(checkbox);checkboxMap.set(option.value,checkbox);const label=document.createElement("label");label.classList.add("snap-select-label");label.textContent=option.textContent;optionDiv.appendChild(label);optionDiv.addEventListener("click",e=>{e.stopPropagation();if(selectedValues.has(option.value)){selectedValues.delete(option.value);checkbox.checked=false}else{if(selectedValues.size<config.maxSelections){selectedValues.add(option.value);checkbox.checked=true}}updateDisplay()})}else{optionDiv.textContent=option.textContent;optionDiv.addEventListener("click",e=>{e.stopPropagation();select.value=option.value;updateSingleSelect(option.textContent);select.dispatchEvent(new Event("change",{bubbles:true}));if(config.closeOnSelect)closeDropdown()})}return optionDiv}const toggleDropdown=e=>{if(e)e.stopPropagation();if(itemsContainer){closeDropdown()}else{document.querySelectorAll(".snap-select-items").forEach(dd=>dd.remove());document.querySelectorAll(".snap-select-overlay").forEach(ov=>ov.remove());if(config.ajax){currentPage=1;currentSearch="";hasMorePages=false}dropdownOverlay=document.createElement("div");dropdownOverlay.classList.add("snap-select-overlay");document.body.appendChild(dropdownOverlay);itemsContainer=document.createElement("div");itemsContainer.classList.add("snap-select-items");itemsContainer.setAttribute("role","listbox");if(isMultiple)itemsContainer.setAttribute("aria-multiselectable","true");itemsContainer.setAttribute("tabindex","-1");itemsContainer.style.display="block";document.body.appendChild(itemsContainer);populateItems();positionDropdown();itemsContainer.focus();customSelect.setAttribute("aria-expanded","true");if(isMultiple){itemsContainer.addEventListener("keydown",e=>{if(e.key==="Escape"){closeDropdown()}else if(e.key==="ArrowDown"||e.key==="ArrowUp"){e.preventDefault();const checkboxes=Array.from(itemsContainer.querySelectorAll(".snap-select-checkbox"));const current=document.activeElement;const currentIndex=checkboxes.indexOf(current);let nextIndex;if(e.key==="ArrowDown"){nextIndex=currentIndex<checkboxes.length-1?currentIndex+1:0}else{nextIndex=currentIndex>0?currentIndex-1:checkboxes.length-1}checkboxes[nextIndex].focus()}else if(e.key===" "||e.key==="Enter"){e.preventDefault();if(document.activeElement.classList.contains("snap-select-checkbox")){document.activeElement.click()}}})}dropdownOverlay.addEventListener("click",event=>{if(event.target===dropdownOverlay)closeDropdown()});const repositionHandler=()=>positionDropdown();const scrollHandler=e=>{if(itemsContainer&&itemsContainer.contains(e.target))return;positionDropdown()};const selectedResizeObserver=new ResizeObserver(()=>positionDropdown());window.addEventListener("scroll",scrollHandler,true);window.addEventListener("resize",repositionHandler);selectedResizeObserver.observe(selectedContainer);customSelect._cleanupHandlers=()=>{window.removeEventListener("scroll",scrollHandler,true);window.removeEventListener("resize",repositionHandler);selectedResizeObserver.disconnect()}}};selectedContainer.addEventListener("click",toggleDropdown);selectedContainer.addEventListener("keydown",e=>{if(e.key==="Enter"||e.key===" "||e.key==="ArrowDown"){e.preventDefault();toggleDropdown()}else if(e.key==="Escape"&&itemsContainer){closeDropdown()}});const observer=new MutationObserver(mutations=>{mutations.forEach(mutation=>{mutation.removedNodes.forEach(node=>{if(node===customSelect||node.contains&&node.contains(customSelect)){closeDropdown();observer.disconnect()}})})});setTimeout(()=>{if(customSelect.parentNode){observer.observe(customSelect.parentNode,{childList:true,subtree:true})}},0);if(isMultiple){Array.from(select.selectedOptions).forEach(option=>{selectedValues.add(option.value)});updateDisplay()}else{const selectedOption=select.querySelector("option:checked");if(selectedOption){updateSingleSelect(selectedOption.textContent)}else{updateSingleSelect(config.placeholder,true)}}this.clear=function(){if(isMultiple){selectedValues.clear();checkboxMap.forEach(cb=>cb.checked=false);updateDisplay()}else{select.value="";updateSingleSelect(config.placeholder,true);select.dispatchEvent(new Event("change",{bubbles:true}))}};this.refresh=function(){if(!config.ajax)return;ajaxCache.delete(_cacheKey(currentSearch,currentPage));if(itemsContainer)_triggerSearch(currentSearch)};this.clearCache=function(){ajaxCache.clear()}}window.SnapSelect=function(selector,options){const elements=document.querySelectorAll(selector);const instances=[];elements.forEach(element=>{instances.push(new SnapSelect(element,options))});return instances.length===1?instances[0]:instances};window.SnapSelectClass=SnapSelect;if(typeof module!=="undefined"&&typeof module.exports!=="undefined"){module.exports=SnapSelect}})();
